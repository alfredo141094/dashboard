<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Qwello Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-main: #1c1e21;
      --success: #00b894;
      --danger: #d63031;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e4e6eb;
      }
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0; padding: 1rem;
      display: flex; flex-direction: column; align-items: center;
    }

    h1 { margin: 1.5rem 0; font-size: 1.8rem; text-align: center; }

    #chargers-container {
      width: 100%; max-width: 650px;
      display: flex; flex-direction: column; gap: 1.5rem;
    }

    .charger-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-top: 6px solid #ccc;
    }

    .charger-card.available { border-top-color: var(--success); }
    .charger-card.unavailable { border-top-color: var(--danger); }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .location-name { font-size: 1.1rem; font-weight: bold; }
    
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    .available .status-badge { background: #e6fffa; color: #008767; }
    .unavailable .status-badge { background: #fff5f5; color: #a02020; }

    .chart-container { height: 150px; margin-top: 1rem; }

    footer { margin-top: 2rem; font-size: 0.8rem; opacity: 0.6; text-align: center; }
    
    .live-indicator {
      display: inline-block; width: 8px; height: 8px;
      background: var(--success); border-radius: 50%;
      margin-right: 5px; animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; }
    }
  </style>
</head>
<body>

  <h1>ðŸ”Œ Monitor Qwello Real-Time</h1>

  <div id="chargers-container">
    <p style="text-align: center;">Conectando con Supabase...</p>
  </div>

  <footer>
    <span class="live-indicator"></span>
    Sincronizado con GitHub Actions cada 15 min<br>
    Ãšltima actualizaciÃ³n: <span id="timestamp">-</span>
  </footer>

  <script>
    // 1. CONFIGURACIÃ“N SUPABASE (RELLENA ESTO)
    const SB_URL = "TU_URL_DE_SUPABASE";
    const SB_KEY = "TU_ANON_KEY_DE_SUPABASE";
    const supabase = AbrirSupabase();

    function AbrirSupabase() {
        if (SB_URL.includes("TU_URL")) return null;
        return exports.supabase.createClient(SB_URL, SB_KEY);
    }

    const CONFIG = {
      pueblo: { name: "Plaza del Pueblo 1", color: "#00b894" },
      bruselas: { name: "Av. de Bruselas 19", color: "#0984e3" }
    };

    const charts = {};

    async function fetchData() {
      if (!supabase) return;

      // Obtener datos de las Ãºltimas 24 horas
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
      
      const { data, error } = await supabase
        .from('chargers_log')
        .select('*')
        .gte('creado_at', oneDayAgo)
        .order('creado_at', { ascending: true });

      if (error) {
        console.error("Error cargando Supabase:", error);
        return;
      }

      processAndRender(data);
      document.getElementById("timestamp").textContent = new Date().toLocaleTimeString();
    }

    function processAndRender(logs) {
      const container = document.getElementById('chargers-container');
      
      // Si es la primera carga, limpiar el "Cargando..."
      if (Object.keys(charts).length === 0) container.innerHTML = '';

      for (const id in CONFIG) {
        // Filtrar logs por cargador
        const chargerLogs = logs.filter(l => l.cargador_id === id);
        const lastEntry = chargerLogs[chargerLogs.length - 1] || { estado: 'unavailable' };
        
        renderCard(id, lastEntry.estado);
        renderChart(id, chargerLogs);
      }
    }

    function renderCard(id, state) {
      let card = document.getElementById(`card-${id}`);
      if (!card) {
        card = document.createElement('div');
        card.id = `card-${id}`;
        document.getElementById('chargers-container').appendChild(card);
      }

      card.className = `charger-card ${state}`;
      card.innerHTML = `
        <div class="header">
          <div class="location-name">${CONFIG[id].name}</div>
          <div class="status-badge">${state === 'available' ? 'Disponible' : 'Ocupado'}</div>
        </div>
        <div class="chart-container">
          <canvas id="chart-${id}"></canvas>
        </div>
      `;
    }

    function renderChart(id, chargerLogs) {
      const ctx = document.getElementById(`chart-${id}`).getContext('2d');
      
      // Preparar datos para las 24 horas (0 = libre, 1 = ocupado)
      // Agrupamos por la hora del log
      const hourlyData = Array(24).fill(null);
      chargerLogs.forEach(log => {
        const hour = new Date(log.creado_at).getHours();
        hourlyData[hour] = log.estado === 'available' ? 0 : 1;
      });

      const backgroundColors = hourlyData.map(v => 
        v === 0 ? '#2ecc71' : (v === 1 ? '#e74c3c' : '#eeeeee')
      );

      if (charts[id]) {
        charts[id].data.datasets[0].backgroundColor = backgroundColors;
        charts[id].update();
      } else {
        charts[id] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}h`),
            datasets: [{
              data: Array(24).fill(1),
              backgroundColor: backgroundColors,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { display: false }, x: { grid: { display: false } } },
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
          }
        });
      }
    }

    // Actualizar cada 30 segundos
    fetchData();
    setInterval(fetchData, 30000);
  </script>
</body>
</html>

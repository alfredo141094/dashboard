<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Qwello Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root { --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --success: #00b894; --danger: #d63031; }
    @media (prefers-color-scheme: dark) { :root { --bg: #121212; --card: #1e1e1e; --text: #e4e6eb; } }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    #chargers-container { width: 100%; max-width: 650px; display: flex; flex-direction: column; gap: 1.5rem; }
    .charger-card { background: var(--card); padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-top: 8px solid #ccc; }
    .charger-card.available { border-top-color: var(--success); }
    .charger-card.unavailable { border-top-color: var(--danger); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .status-badge { padding: 0.4rem 0.8rem; border-radius: 50px; font-size: 0.8rem; font-weight: bold; }
    .available .status-badge { background: #e6fffa; color: #008767; }
    .unavailable .status-badge { background: #fff5f5; color: #a02020; }
    .chart-box { height: 160px; margin-top: 1rem; }
    footer { margin-top: 2rem; font-size: 0.8rem; opacity: 0.6; text-align: center; }
  </style>
</head>
<body>

  <h1>üîå Monitor Qwello Real-Time</h1>
  
  <div id="chargers-container">
    <p id="msg" style="text-align: center; padding: 2rem;">Cargando datos desde Supabase...</p>
  </div>

  <footer>
    Actualizaci√≥n autom√°tica activa (cada 30s)<br>
    Sincronizado: <span id="timestamp">-</span>
  </footer>

  <script>
    // 1. Configuraci√≥n de credenciales
    const SB_URL = "https://mmxqckekhfaqrqgcabvh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1teHFja2VraGZhcXJxZ2NhYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjczNzEsImV4cCI6MjA4MTYwMzM3MX0.gl7HYm_o-XC7yKqguusx1lM6ULZ_htuuvrKyvoBLQXU";
    
    // Cambiamos el nombre a sbClient para evitar el SyntaxError
    const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    const charts = {};

    async function loadData() {
      // Pedimos los √∫ltimos 150 registros de la tabla 'lecturas'
      const { data, error } = await sbClient
        .from('lecturas') 
        .select('*')
        .order('creado_at', { ascending: true })
        .limit(150);

      if (error) {
        document.getElementById('msg').innerHTML = "‚ùå Error: " + error.message;
        return;
      }

      if (data && data.length > 0) {
        document.getElementById('msg').style.display = 'none';
        renderDashboard(data);
      } else {
        document.getElementById('msg').innerHTML = "Base de datos conectada pero vac√≠a.";
      }
      document.getElementById("timestamp").textContent = new Date().toLocaleTimeString();
    }

    function renderDashboard(data) {
      const container = document.getElementById('chargers-container');
      const ids = ["pueblo", "bruselas"];

      ids.forEach(id => {
        // Filtrar datos para cada cargador
        const logs = data.filter(l => l.cargador_id === id);
        const lastEntry = logs[logs.length - 1] || { estado: 'unavailable' };
        
        let card = document.getElementById(`card-${id}`);
        if (!card) {
          card = document.createElement('div');
          card.id = `card-${id}`;
          container.appendChild(card);
        }

        card.className = `charger-card ${lastEntry.estado}`;
        card.innerHTML = `
          <div class="header">
            <strong>${id === 'pueblo' ? 'Plaza del Pueblo 1' : 'Av. de Bruselas 19'}</strong>
            <span class="status-badge">${lastEntry.estado === 'available' ? 'LIBRE ‚úÖ' : 'OCUPADO ‚ùå'}</span>
          </div>
          <div class="chart-box"><canvas id="chart-${id}"></canvas></div>
        `;
        
        updateChart(id, logs);
      });
    }

    function updateChart(id, logs) {
      const ctx = document.getElementById(`chart-${id}`).getContext('2d');
      
      // Mapear el estado a las horas del d√≠a (0-23)
      const hourlyData = Array(24).fill(null);
      logs.forEach(log => {
        const date = new Date(log.creado_at);
        const hour = date.getHours();
        hourlyData[hour] = log.estado === 'available' ? 0 : 1;
      });

      const colors = hourlyData.map(v => 
        v === 0 ? '#00b894' : (v === 1 ? '#d63031' : '#eeeeee')
      );

      if (charts[id]) {
        charts[id].data.datasets[0].backgroundColor = colors;
        charts[id].update();
      } else {
        charts[id] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}h`),
            datasets: [{ 
              data: Array(24).fill(1), 
              backgroundColor: colors, 
              borderRadius: 4 
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { display: false }, x: { grid: { display: false } } },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // Ejecutar al cargar y cada 30 segundos
    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>

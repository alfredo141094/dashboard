<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Qwello Pro | Plaza del Pueblo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #10b981;
      --danger: #ef4444;
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #0f172a;
      --text-light: #64748b;
      --border: #e2e8f0;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #020617;
        --card: #0f172a;
        --text: #f1f5f9;
        --text-light: #94a3b8;
        --border: #1e293b;
      }
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
    }

    .app-container {
      width: 100%;
      max-width: 600px;
    }

    /* --- HEADER --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 2rem;
    }

    .header h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }
    .current-time { font-size: 0.85rem; color: var(--text-light); font-weight: 500; }

    /* --- MAIN STATUS CARD --- */
    .hero-card {
      background: var(--card);
      border-radius: 28px;
      padding: 2rem;
      border: 1px solid var(--border);
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }

    .available .status-pill { background: #d1fae5; color: #065f46; }
    .unavailable .status-pill { background: #fee2e2; color: #991b1b; }

    .location-name { font-size: 1.75rem; font-weight: 800; margin: 0.5rem 0; letter-spacing: -0.03em; }
    .time-in-state { font-size: 0.9rem; color: var(--text-light); }

    /* --- GRID DE 24 HORAS --- */
    .grid-container {
      background: var(--card);
      border-radius: 24px;
      padding: 1.5rem;
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }

    .grid-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
      margin-bottom: 1.25rem;
      display: block;
    }

    .hour-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 8px;
    }

    .hour-block {
      height: 40px;
      border-radius: 8px;
      position: relative;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .hour-fill {
      width: 100%;
      transition: height 0.5s ease;
    }

    .hour-fill.available { background: var(--primary); }
    .hour-fill.occupied { background: var(--danger); }

    .hour-number {
      font-size: 0.65rem;
      color: var(--text-light);
      margin-top: 6px;
      text-align: center;
      font-weight: 600;
    }

    /* --- EVENTOS RECIENTES --- */
    .events-card {
      background: var(--card);
      border-radius: 24px;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .event-row {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
    }

    .event-row:last-child { border: none; }

    .event-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 1.2rem;
    }

    .event-info { flex-grow: 1; }
    .event-title { font-size: 0.9rem; font-weight: 700; display: block; }
    .event-time { font-size: 0.8rem; color: var(--text-light); }

  </style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <div>
      <span class="current-time" id="real-time">Cargando hora...</span>
      <h1>Monitor Pro</h1>
    </div>
    <div style="text-align: right">
      <span class="status-pill" style="margin:0; background: var(--border); color: var(--text)">Plaza del Pueblo, 1</span>
    </div>
  </div>

  <div id="status-card" class="hero-card">
    <div class="status-pill">Sincronizando...</div>
    <div class="location-name">Plaza del Pueblo, 1</div>
    <div class="time-in-state" id="duration">Calculando tiempo...</div>
  </div>

  <div class="grid-container">
    <span class="grid-label">Disponibilidad (Ãšltimas 24h)</span>
    <div class="hour-grid" id="hour-grid">
      </div>
  </div>

  <div class="events-card">
    <span class="grid-label">Ãšltimos Movimientos</span>
    <div id="event-list">
      </div>
  </div>
</div>

<script>
  const SB_URL = "https://mmxqckekhfaqrqgcabvh.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1teHFja2VraGZhcXJxZ2NhYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjczNzEsImV4cCI6MjA4MTYwMzM3MX0.gl7HYm_o-XC7yKqguusx1lM6ULZ_htuuvrKyvoBLQXU";
  const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

  function updateClock() {
    const now = new Date();
    document.getElementById('real-time').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
  }
  setInterval(updateClock, 1000);

  async function loadData() {
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
    const { data, error } = await sbClient
      .from('lecturas')
      .select('*')
      .eq('cargador_id', 'pueblo')
      .gte('creado_at', oneDayAgo)
      .order('creado_at', { ascending: true });

    if (data) {
      renderStatus(data);
      renderGrid(data);
      renderEvents(data);
    }
  }

  function renderStatus(data) {
    const last = data[data.length - 1];
    const card = document.getElementById('status-card');
    const isAvail = last.estado === 'available';
    
    card.className = `hero-card ${isAvail ? 'available' : 'unavailable'}`;
    card.querySelector('.status-pill').textContent = isAvail ? 'â— Disponible' : 'â— Ocupado';
    
    // CÃ¡lculo de tiempo en el estado
    let lastChangeIdx = data.length - 1;
    for (let i = data.length - 1; i >= 0; i--) {
      if (data[i].estado !== last.estado) { lastChangeIdx = i + 1; break; }
    }
    const diff = Math.floor((Date.now() - new Date(data[lastChangeIdx].creado_at)) / 60000);
    document.getElementById('duration').textContent = `En este estado desde hace ${diff} min`;
  }

  function renderGrid(data) {
    const grid = document.getElementById('hour-grid');
    grid.innerHTML = '';
    
    // Agrupar por horas
    const hourlyStats = Array(24).fill(0).map((_, i) => ({ hour: i, available: 0, total: 0 }));
    
    data.forEach(d => {
      const h = new Date(d.creado_at).getHours();
      hourlyStats[h].total++;
      if (d.estado === 'available') hourlyStats[h].available++;
    });

    // Ordenar para que la Ãºltima hora sea la actual
    const currentHour = new Date().getHours();
    for (let i = 0; i < 24; i++) {
      const hIdx = (currentHour + 1 + i) % 24;
      const stat = hourlyStats[hIdx];
      const percentage = stat.total > 0 ? (stat.available / stat.total) * 100 : 0;
      
      const container = document.createElement('div');
      container.innerHTML = `
        <div class="hour-block">
          <div class="hour-fill ${percentage > 50 ? 'available' : 'occupied'}" style="height: ${percentage || 10}%"></div>
        </div>
        <div class="hour-number">${hIdx}h</div>
      `;
      grid.appendChild(container);
    }
  }

  function renderEvents(data) {
    const list = document.getElementById('event-list');
    const events = [];
    for (let i = data.length - 1; i > 0; i--) {
      if (data[i].estado !== data[i-1].estado) {
        events.push(data[i]);
      }
      if (events.length === 3) break;
    }

    list.innerHTML = events.map(e => `
      <div class="event-row">
        <div class="event-icon" style="background: ${e.estado === 'available' ? '#d1fae5' : '#fee2e2'}">
          ${e.estado === 'available' ? 'âœ…' : 'ðŸ”Œ'}
        </div>
        <div class="event-info">
          <span class="event-title">${e.estado === 'available' ? 'Cargador Libre' : 'Carga Iniciada'}</span>
          <span class="event-time">${new Date(e.creado_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
      </div>
    `).join('');
  }

  loadData();
  setInterval(loadData, 30000);
</script>

</body>
</html>

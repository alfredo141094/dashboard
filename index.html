<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Qwello Precision Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --success: #00b894; --danger: #d63031; --gray: #e0e0e0; }
    @media (prefers-color-scheme: dark) { :root { --bg: #121212; --card: #1e1e1e; --text: #e4e6eb; --gray: #333; } }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    #chargers-container { width: 100%; max-width: 650px; display: flex; flex-direction: column; gap: 1.5rem; }
    .charger-card { background: var(--card); padding: 1.5rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-top: 8px solid #ccc; }
    .charger-card.available { border-top-color: var(--success); }
    .charger-card.unavailable { border-top-color: var(--danger); }
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .location-info { display: flex; flex-direction: column; }
    .location-name { font-size: 1.1rem; font-weight: bold; }
    .status-badge-main { padding: 0.4rem 0.8rem; border-radius: 50px; font-size: 0.75rem; font-weight: bold; }
    .available .status-badge-main { background: #e6fffa; color: #008767; }
    .unavailable .status-badge-main { background: #fff5f5; color: #a02020; }
    .chart-box { height: 140px; margin-top: 1rem; }
    footer { margin-top: 3rem; font-size: 0.8rem; opacity: 0.6; text-align: center; }
  </style>
</head>
<body>

  <h1>ðŸ”Œ Qwello Precision Monitor</h1>
  <div id="chargers-container">
    <p id="msg" style="text-align: center; padding: 2rem;">Calculando proporciones exactas...</p>
  </div>

  <script>
    const SB_URL = "https://mmxqckekhfaqrqgcabvh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1teHFja2VraGZhcXJxZ2NhYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjczNzEsImV4cCI6MjA4MTYwMzM3MX0.gl7HYm_o-XC7yKqguusx1lM6ULZ_htuuvrKyvoBLQXU";
    const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    const charts = {};

    async function loadData() {
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
      const { data, error } = await sbClient
        .from('lecturas') 
        .select('*')
        .gte('creado_at', oneDayAgo.toISOString())
        .order('creado_at', { ascending: true });

      if (error) return console.error(error);
      if (data) {
        document.getElementById('msg').style.display = 'none';
        renderDashboard(data);
      }
    }

    function processPrecisionData(logs) {
      const hourlyData = Array(24).fill(null).map(() => ({ green: 0, red: 0, gray: 60 }));
      if (logs.length < 2) return hourlyData;

      for (let i = 0; i < logs.length - 1; i++) {
        const start = new Date(logs[i].creado_at);
        const end = new Date(logs[i+1].creado_at);
        const state = logs[i].estado;
        
        let cursor = new Date(start);

        while (cursor < end) {
          const currentHour = cursor.getHours();
          const nextHour = new Date(cursor);
          nextHour.setHours(currentHour + 1, 0, 0, 0);
          
          const limit = end < nextHour ? end : nextHour;
          const durationMins = (limit - cursor) / 60000;

          if (state === 'available') {
            hourlyData[currentHour].green += durationMins;
          } else {
            hourlyData[currentHour].red += durationMins;
          }
          
          hourlyData[currentHour].gray = Math.max(0, 60 - (hourlyData[currentHour].green + hourlyData[currentHour].red));
          cursor = limit;
        }
      }
      return hourlyData;
    }

    function renderDashboard(data) {
      const container = document.getElementById('chargers-container');
      ["pueblo", "bruselas"].forEach(id => {
        const logs = data.filter(l => l.cargador_id === id);
        const lastEntry = logs[logs.length - 1] || { estado: 'unavailable' };
        
        let card = document.getElementById(`card-${id}`);
        if (!card) {
          card = document.createElement('div');
          card.id = `card-${id}`;
          card.className = `charger-card ${lastEntry.estado}`;
          card.innerHTML = `
            <div class="header">
              <div class="location-info"><span class="location-name">${id}</span></div>
              <span class="status-badge-main">...</span>
            </div>
            <div class="chart-box"><canvas id="chart-${id}"></canvas></div>
          `;
          container.appendChild(card);
        }

        card.className = `charger-card ${lastEntry.estado}`;
        card.querySelector('.status-badge-main').textContent = lastEntry.estado === 'available' ? 'LIBRE âœ…' : 'OCUPADO âŒ';
        updateChart(id, logs);
      });
    }

    function updateChart(id, logs) {
      const stats = processPrecisionData(logs);
      const ctx = document.getElementById(`chart-${id}`).getContext('2d');

      const dataConfig = {
        labels: Array.from({length: 24}, (_, i) => `${i}h`),
        datasets: [
          { label: 'Libre', data: stats.map(s => s.green), backgroundColor: '#00b894', stack: 'A' },
          { label: 'Ocupado', data: stats.map(s => s.red), backgroundColor: '#d63031', stack: 'A' },
          { label: 'Sin datos', data: stats.map(s => s.gray), backgroundColor: '#e0e0e0', stack: 'A' }
        ]
      };

      if (charts[id]) {
        charts[id].data = dataConfig;
        charts[id].update('none');
      } else {
        charts[id] = new Chart(ctx, {
          type: 'bar',
          data: dataConfig,
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { stacked: true, max: 60, display: false }, x: { stacked: true, grid: { display: false } } },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Qwello Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root { 
      --bg: #f0f2f5; 
      --card: #ffffff; 
      --text: #1c1e21; 
      --success: #00b894; 
      --danger: #d63031; 
    }
    @media (prefers-color-scheme: dark) { 
      :root { --bg: #121212; --card: #1e1e1e; --text: #e4e6eb; } 
    }
    
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      margin: 0; padding: 1rem; 
      display: flex; flex-direction: column; align-items: center; 
    }
    
    h1 { margin: 1.5rem 0; font-size: 1.8rem; text-align: center; }
    
    #chargers-container { 
      width: 100%; 
      max-width: 650px; 
      display: flex; 
      flex-direction: column; 
      gap: 1.5rem; 
    }
    
    .charger-card { 
      background: var(--card); 
      padding: 1.5rem; 
      border-radius: 20px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      border-top: 8px solid #ccc; 
      transition: transform 0.2s ease;
    }
    
    .charger-card.available { border-top-color: var(--success); }
    .charger-card.unavailable { border-top-color: var(--danger); }

    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .location-info { display: flex; flex-direction: column; }
    .location-name { font-size: 1.1rem; font-weight: bold; }
    .status-timer { font-size: 0.85rem; opacity: 0.7; margin-top: 2px; }
    
    .stats-badge { 
      font-size: 0.75rem; 
      font-weight: bold; 
      padding: 4px 10px; 
      border-radius: 8px; 
      background: rgba(0,0,0,0.05); 
      margin-top: 8px; 
      display: inline-block; 
    }

    .status-badge-main { 
      padding: 0.4rem 0.8rem; 
      border-radius: 50px; 
      font-size: 0.75rem; 
      font-weight: bold; 
    }
    .available .status-badge-main { background: #e6fffa; color: #008767; }
    .unavailable .status-badge-main { background: #fff5f5; color: #a02020; }

    .chart-box { height: 140px; margin-top: 1rem; }
    
    .history-list { 
      margin-top: 1rem; 
      padding-top: 1rem; 
      border-top: 1px solid rgba(0,0,0,0.1); 
      font-size: 0.8rem; 
    }
    .history-item { display: flex; justify-content: space-between; margin-bottom: 4px; opacity: 0.8; }
    .history-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

    footer { margin-top: 3rem; font-size: 0.8rem; opacity: 0.6; text-align: center; }
  </style>
</head>
<body>

  <h1>üîå Monitor Qwello Pro</h1>
  
  <div id="chargers-container">
    <p id="msg" style="text-align: center; padding: 2rem;">Inicializando sistema de an√°lisis...</p>
  </div>

  <footer>
    Actualizaci√≥n autom√°tica inteligente (cada 30s)<br>
    Sincronizado: <span id="timestamp">-</span>
  </footer>

  <script>
    const SB_URL = "https://mmxqckekhfaqrqgcabvh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1teHFja2VraGZhcXJxZ2NhYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjczNzEsImV4cCI6MjA4MTYwMzM3MX0.gl7HYm_o-XC7yKqguusx1lM6ULZ_htuuvrKyvoBLQXU";
    
    const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
    const charts = {};

    async function loadData() {
      const { data, error } = await supabaseClient
        .from('lecturas') 
        .select('*')
        .order('creado_at', { ascending: true })
        .limit(300);

      if (error) return console.error("Error Supabase:", error);

      if (data && data.length > 0) {
        document.getElementById('msg').style.display = 'none';
        renderDashboard(data);
      }
      document.getElementById("timestamp").textContent = new Date().toLocaleTimeString();
    }

    function calculateStats(logs) {
      if (logs.length === 0) return { percent: 0, duration: '...', events: [] };

      // 1. % Disponibilidad hoy
      const todayStart = new Date().setHours(0,0,0,0);
      const logsToday = logs.filter(l => new Date(l.creado_at) >= todayStart);
      const availableToday = logsToday.filter(l => l.estado === 'available').length;
      const percent = logsToday.length > 0 ? Math.round((availableToday / logsToday.length) * 100) : 0;

      // 2. Tiempo en estado actual
      const currentStatus = logs[logs.length - 1].estado;
      let lastChangeIdx = logs.length - 1;
      for (let i = logs.length - 1; i >= 0; i--) {
        if (logs[i].estado !== currentStatus) {
          lastChangeIdx = i + 1;
          break;
        }
        if (i === 0) lastChangeIdx = 0;
      }
      const diffMs = Date.now() - new Date(logs[lastChangeIdx].creado_at);
      const mins = Math.floor(diffMs / 60000);
      const duration = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;

      // 3. √öltimos 3 cambios
      const events = [];
      for (let i = logs.length - 1; i > 0; i--) {
        if (logs[i].estado !== logs[i-1].estado) {
          events.push({
            time: new Date(logs[i].creado_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            status: logs[i].estado,
            text: logs[i].estado === 'available' ? 'Se liber√≥' : 'Se ocup√≥'
          });
        }
        if (events.length === 3) break;
      }

      return { percent, duration, events };
    }

    function renderDashboard(data) {
      const container = document.getElementById('chargers-container');
      const ids = ["pueblo", "bruselas"];

      ids.forEach(id => {
        const logs = data.filter(l => l.cargador_id === id);
        const lastEntry = logs[logs.length - 1] || { estado: 'unavailable' };
        const stats = calculateStats(logs);
        
        let card = document.getElementById(`card-${id}`);
        
        // Crear estructura base solo si no existe
        if (!card) {
          card = document.createElement('div');
          card.id = `card-${id}`;
          card.className = `charger-card ${lastEntry.estado}`;
          card.innerHTML = `
            <div class="header">
              <div class="location-info">
                <span class="location-name">${id === 'pueblo' ? 'Plaza del Pueblo 1' : 'Av. de Bruselas 19'}</span>
                <span class="status-timer">üïí ...</span>
                <span class="stats-badge">üìä ...</span>
              </div>
              <span class="status-badge-main">...</span>
            </div>
            <div class="chart-box"><canvas id="chart-${id}"></canvas></div>
            <div class="history-list"></div>
          `;
          container.appendChild(card);
        }

        // Actualizaci√≥n parcial (mantiene el canvas vivo)
        card.className = `charger-card ${lastEntry.estado}`;
        card.querySelector('.status-timer').textContent = `üïí En este estado hace ${stats.duration}`;
        card.querySelector('.stats-badge').textContent = `üìä Hoy disponible: ${stats.percent}%`;
        
        const badge = card.querySelector('.status-badge-main');
        badge.textContent = lastEntry.estado === 'available' ? 'LIBRE ‚úÖ' : 'OCUPADO ‚ùå';

        const historyBox = card.querySelector('.history-list');
        historyBox.innerHTML = `<strong>√öltimos movimientos:</strong>` + 
          (stats.events.map(e => `
            <div class="history-item">
              <span><span class="history-dot" style="background:${e.status === 'available' ? '#00b894' : '#d63031'}"></span>${e.text}</span>
              <span>${e.time}</span>
            </div>
          `).join('') || '<div style="opacity:0.5; margin-top:5px;">Sin cambios recientes</div>');

        updateChart(id, logs);
      });
    }

    function updateChart(id, logs) {
      const canvas = document.getElementById(`chart-${id}`);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const hourlyData = Array(24).fill(null);
      
      logs.forEach(log => {
        const hour = new Date(log.creado_at).getHours();
        hourlyData[hour] = log.estado === 'available' ? 0 : 1;
      });

      const colors = hourlyData.map(v => v === 0 ? '#00b894' : (v === 1 ? '#d63031' : '#eee'));

      if (charts[id]) {
        charts[id].data.datasets[0].backgroundColor = colors;
        charts[id].update('none'); // Update sin animaciones para evitar saltos visuales
      } else {
        charts[id] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}h`),
            datasets: [{ data: Array(24).fill(1), backgroundColor: colors, borderRadius: 4 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
              y: { display: false }, 
              x: { grid: { display: false }, ticks: { font: {size: 9} } } 
            },
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
          }
        });
      }
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
